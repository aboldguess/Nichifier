{#
admin_monetisation.html
=======================
Mini-README: Hidden admin-only control panel for managing monetisation settings,
including platform fee percentages and curator subscription tiers. Presents forms with
clear inline instructions so operators can configure Stripe keys and plan pricing.
#}
{% extends "base.html" %}

{% block instructions %}
<div class="alert alert-warning" role="alert">
  This laboratory controls how Nichifier earns revenue. Adjust platform fees, Stripe
  keys, and curator plans carefully. Every update takes effect immediately, so double
  check figures before saving.
</div>
{% endblock %}

{% block content %}
<div class="row g-4">
  <div class="col-lg-5">
    <div class="card shadow-sm">
      <div class="card-body">
        <h2 class="card-title h4">Platform fee configuration</h2>
        <p class="text-muted">Set the default revenue share that applies to every paid subscriber.</p>
        <form method="post" action="/admin/monetisation/settings" class="vstack gap-3">
          <div>
            <label class="form-label" for="platform_fee_percent">Platform fee percentage</label>
            <input
              class="form-control"
              type="number"
              id="platform_fee_percent"
              name="platform_fee_percent"
              step="0.01"
              min="0"
              value="{{ settings.platform_fee_percent }}"
              required
            />
            <div class="form-text">Our default cut from each paid subscription.</div>
          </div>
          <div>
            <label class="form-label" for="minimum_platform_fee">Minimum fee ({{ settings.currency_code }})</label>
            <input
              class="form-control"
              type="number"
              id="minimum_platform_fee"
              name="minimum_platform_fee"
              step="0.01"
              min="0"
              value="{{ settings.minimum_platform_fee }}"
              required
            />
            <div class="form-text">Safety net so we always collect at least this amount per billing cycle.</div>
          </div>
          <div>
            <label class="form-label" for="currency_code">Default currency</label>
            <input
              class="form-control"
              type="text"
              id="currency_code"
              name="currency_code"
              maxlength="3"
              value="{{ settings.currency_code }}"
              required
            />
            <div class="form-text">Use ISO codes like GBP, USD, or EUR.</div>
          </div>
          <div>
            <label class="form-label" for="stripe_publishable_key">Stripe publishable key</label>
            <input
              class="form-control"
              type="text"
              id="stripe_publishable_key"
              name="stripe_publishable_key"
              value="{{ settings.stripe_publishable_key or '' }}"
              placeholder="pk_live_..."
            />
          </div>
          <div>
            <label class="form-label" for="stripe_secret_key">Stripe secret key</label>
            <input
              class="form-control"
              type="text"
              id="stripe_secret_key"
              name="stripe_secret_key"
              value="{{ settings.stripe_secret_key or '' }}"
              placeholder="sk_live_..."
            />
          </div>
          <button class="btn btn-success" type="submit">Save monetisation settings</button>
        </form>
      </div>
    </div>
  </div>
  <div class="col-lg-7">
    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <h2 class="card-title h4">Existing curator plans</h2>
        <p class="text-muted">Update a plan inline. Creators see these tiers when upgrading their account.</p>
        {% if plans %}
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th scope="col">Name</th>
                <th scope="col">Monthly fee</th>
                <th scope="col">Platform discount</th>
                <th scope="col">Max niches</th>
                <th scope="col">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for plan in plans %}
              <tr>
                <td>
                  <form method="post" action="/admin/monetisation/plan" class="row g-2 align-items-center">
                    <input type="hidden" name="plan_id" value="{{ plan.id }}" />
                    <div class="col-md-4">
                      <label class="form-label" for="slug_{{ plan.id }}">Slug</label>
                      <input class="form-control form-control-sm" type="text" id="slug_{{ plan.id }}" name="slug" value="{{ plan.slug }}" required />
                    </div>
                    <div class="col-md-8">
                      <label class="form-label" for="display_name_{{ plan.id }}">Display name</label>
                      <input class="form-control form-control-sm" type="text" id="display_name_{{ plan.id }}" name="display_name" value="{{ plan.display_name }}" required />
                    </div>
                    <div class="col-md-6">
                      <label class="form-label" for="monthly_fee_{{ plan.id }}">Monthly fee</label>
                      <input class="form-control form-control-sm" type="number" step="0.01" name="monthly_fee" id="monthly_fee_{{ plan.id }}" value="{{ plan.monthly_fee }}" />
                    </div>
                    <div class="col-md-6">
                      <label class="form-label" for="currency_code_{{ plan.id }}">Currency</label>
                      <input class="form-control form-control-sm" type="text" maxlength="3" name="currency_code" id="currency_code_{{ plan.id }}" value="{{ plan.currency_code }}" />
                    </div>
                    <div class="col-md-6">
                      <label class="form-label" for="platform_fee_discount_percent_{{ plan.id }}">Platform discount (%)</label>
                      <input class="form-control form-control-sm" type="number" step="0.01" name="platform_fee_discount_percent" id="platform_fee_discount_percent_{{ plan.id }}" value="{{ plan.platform_fee_discount_percent }}" />
                    </div>
                    <div class="col-md-6">
                      <label class="form-label" for="max_niches_{{ plan.id }}">Max niches</label>
                      <input class="form-control form-control-sm" type="number" min="1" name="max_niches" id="max_niches_{{ plan.id }}" value="{{ plan.max_niches }}" />
                    </div>
                    <div class="col-12">
                      <label class="form-label" for="feature_summary_{{ plan.id }}">Feature summary</label>
                      <textarea class="form-control form-control-sm" id="feature_summary_{{ plan.id }}" name="feature_summary" rows="2">{{ plan.feature_summary }}</textarea>
                    </div>
                    <div class="col-12">
                      <label class="form-label" for="description_{{ plan.id }}">Long description</label>
                      <textarea class="form-control form-control-sm" id="description_{{ plan.id }}" name="description" rows="2">{{ plan.description or '' }}</textarea>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label" for="stripe_price_id_{{ plan.id }}">Stripe price ID</label>
                      <input class="form-control form-control-sm" type="text" name="stripe_price_id" id="stripe_price_id_{{ plan.id }}" value="{{ plan.stripe_price_id or '' }}" />
                    </div>
                    <div class="col-md-6 d-flex align-items-end">
                      <button class="btn btn-primary btn-sm w-100" type="submit">Update plan</button>
                    </div>
                  </form>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <p class="mb-0">No curator plans defined yet. Use the form below to create one.</p>
        {% endif %}
      </div>
    </div>
    <div class="card shadow-sm">
      <div class="card-body">
        <h2 class="card-title h4">Create new curator plan</h2>
        <p class="text-muted">Launch a tier with bespoke pricing and platform fee discounts.</p>
        <form method="post" action="/admin/monetisation/plan" class="row g-3">
          <div class="col-md-4">
            <label class="form-label" for="new_slug">Slug</label>
            <input class="form-control" type="text" id="new_slug" name="slug" placeholder="pro" required />
          </div>
          <div class="col-md-8">
            <label class="form-label" for="new_display_name">Display name</label>
            <input class="form-control" type="text" id="new_display_name" name="display_name" placeholder="Pro Curator" required />
          </div>
          <div class="col-md-6">
            <label class="form-label" for="new_monthly_fee">Monthly fee ({{ settings.currency_code }})</label>
            <input class="form-control" type="number" step="0.01" id="new_monthly_fee" name="monthly_fee" value="0" />
          </div>
          <div class="col-md-6">
            <label class="form-label" for="new_currency_code">Currency</label>
            <input class="form-control" type="text" id="new_currency_code" name="currency_code" maxlength="3" value="{{ settings.currency_code }}" />
          </div>
          <div class="col-md-6">
            <label class="form-label" for="new_platform_fee_discount_percent">Platform discount (%)</label>
            <input class="form-control" type="number" step="0.01" id="new_platform_fee_discount_percent" name="platform_fee_discount_percent" value="0" />
          </div>
          <div class="col-md-6">
            <label class="form-label" for="new_max_niches">Max niches</label>
            <input class="form-control" type="number" id="new_max_niches" name="max_niches" value="1" min="1" />
          </div>
          <div class="col-12">
            <label class="form-label" for="new_feature_summary">Feature summary</label>
            <textarea class="form-control" id="new_feature_summary" name="feature_summary" rows="2" placeholder="List benefits and limits"></textarea>
          </div>
          <div class="col-12">
            <label class="form-label" for="new_description">Long description</label>
            <textarea class="form-control" id="new_description" name="description" rows="3" placeholder="Explain what's included at this tier"></textarea>
          </div>
          <div class="col-md-6">
            <label class="form-label" for="new_stripe_price_id">Stripe price ID</label>
            <input class="form-control" type="text" id="new_stripe_price_id" name="stripe_price_id" placeholder="price_..." />
          </div>
          <div class="col-md-6 d-flex align-items-end">
            <button class="btn btn-outline-success w-100" type="submit">Create plan</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}
